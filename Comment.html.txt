<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
      body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
      .comment-card {
        border-left: 4px solid #0d6efd;
        margin-bottom: 15px;
        transition: 0.2s;
        background: white;
      }
      .comment-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      #comment-list { min-height: 100px; }
    </style>
  </head>
  <body class="p-4">
    <div class="container bg-white shadow-sm p-4 rounded">
      <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <h2 class="text-primary fw-bold" id="club-title">è¼‰å…¥ä¸­...</h2>
        <button class="btn btn-outline-secondary" onclick="navBack()">è¿”å›ç¤¾åœ˜åˆ—è¡¨</button>
      </div>

      <div class="mb-5">
        <h4 class="mb-3">ğŸ’¬ ç¤¾å“¡ç•™è¨€æ¿</h4>
        <div id="comment-list">
          <div class="text-center text-muted py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
            </div>
            <p class="mt-2">æ­£åœ¨è®€å–ç•™è¨€...</p>
          </div>
        </div>
      </div>

      <div class="card p-4 bg-light border-0">
        <h5 class="mb-3">âœï¸ ç™¼è¡¨ç•™è¨€</h5>
        <div class="mb-3">
          <label class="form-label fw-bold">æš±ç¨±</label>
          <input type="text" id="nickname-input" class="form-control" placeholder="è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±ï¼ˆé¸å¡«ï¼‰">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">ç•™è¨€å…§å®¹</label>
          <textarea id="content-input" class="form-control" rows="4" placeholder="åˆ†äº«æ‚¨å°é€™å€‹ç¤¾åœ˜çš„æƒ³æ³•..."></textarea>
        </div>
        <button class="btn btn-primary w-100 py-2 fw-bold" id="submit-btn" onclick="submitComment()">é€å‡ºç•™è¨€</button>
      </div>
    </div>

    <script>
  // 1. ç›´æ¥è®€å–å¾ Code.gs å‚³éä¾†çš„è®Šæ•¸
  // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨çš„æ˜¯ Google Script ç‰¹æœ‰çš„ Scriptlet èªæ³•
  let currentClubName = "<?= clubFromUrl ?>"; 

  document.addEventListener('DOMContentLoaded', () => {
    // 2. å¦‚æœå¾Œç«¯å‚³ä¾†çš„è®Šæ•¸æ˜¯ç©ºçš„ï¼Œæ‰å˜—è©¦å¾ç¶²å€æŠ“ (é›™é‡ä¿éšª)
    if (!currentClubName) {
      const urlParams = new URLSearchParams(window.location.search);
      const clubParam = urlParams.get('club');
      if (clubParam) {
        currentClubName = decodeURIComponent(clubParam).trim();
      }
    }

    // 3. å¦‚æœå…©è€…éƒ½æ²’æœ‰ï¼Œæ‰é¡¯ç¤ºé è¨­å€¼
    if (!currentClubName) {
      currentClubName = "æœªçŸ¥ç¤¾åœ˜";
    }

    // 4. æ›´æ–° UI
    document.getElementById('club-title').innerText = currentClubName;
    
    // 5. è¼‰å…¥ç•™è¨€
    loadComments();
  });

  // ... å‰©ä¸‹çš„ loadComments, renderComments ç­‰å‡½æ•¸ä¿æŒä¸è®Š ...

    function loadComments() {
    // é€™è£¡æˆ‘å€‘ç¨å¾®å»¶é²ä¸€ä¸‹ï¼Œç¢ºä¿ currentClubName å·²ç¶“è¢«è³¦å€¼
    setTimeout(() => {
      let clubToSearch = currentClubName;
      
      // å¦‚æœæ¨™é¡Œå·²ç¶“è®Šæ›´äº†ï¼Œå°±ä»¥æ¨™é¡Œç‚ºæº–
      const titleText = document.getElementById('club-title').innerText;
      if (titleText && titleText !== "è¼‰å…¥ä¸­...") {
        clubToSearch = titleText;
      }

      console.log("å‰ç«¯æº–å‚™æŸ¥è©¢: ", clubToSearch);

      google.script.run
        .withSuccessHandler(renderComments)
        .withFailureHandler(handleError)
        .listComments(clubToSearch.trim());
    }, 100); 
  }
      // âš ï¸ ä¹‹å‰å¯èƒ½ç¼ºå°‘çš„æ¸²æŸ“å‡½æ•¸
      function renderComments(comments) {
        const listDiv = document.getElementById('comment-list');
        if (!comments || comments.length === 0) {
          listDiv.innerHTML = '<div class="alert alert-info border-0 shadow-sm">ç›®å‰é‚„æ²’æœ‰ç•™è¨€ï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€å€‹ï¼</div>';
          return;
        }

        let html = '';
        comments.forEach(c => {
          // è™•ç†æ™‚é–“æ ¼å¼
          let timeStr = "";
          try {
            timeStr = c.created_at ? new Date(c.created_at).toLocaleString('zh-TW') : "æ™‚é–“æœªçŸ¥";
          } catch(e) { timeStr = "æ™‚é–“æ ¼å¼éŒ¯èª¤"; }

          html += `
            <div class="card comment-card p-3 shadow-sm border-top-0 border-end-0 border-bottom-0">
              <div class="d-flex justify-content-between">
                <h6 class="text-primary fw-bold">ğŸ‘¤ ${c.nickname || 'åŒ¿å'}</h6>
                <small class="text-muted">${timeStr}</small>
              </div>
              <p class="mb-0 mt-2 text-secondary">${c.content}</p>
            </div>`;
        });
        listDiv.innerHTML = html;
      }

      function submitComment() {
        const contentInput = document.getElementById('content-input');
        const content = contentInput.value.trim();
        if (!content) { alert('è«‹è¼¸å…¥å…§å®¹'); return; }

        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerText = "å‚³é€ä¸­...";

        const payload = {
          club: currentClubName,
          nickname: document.getElementById('nickname-input').value.trim() || 'åŒ¿å',
          content: content
        };

        google.script.run
          .withSuccessHandler(() => {
            alert('ç•™è¨€æˆåŠŸ');
            contentInput.value = '';
            btn.disabled = false;
            btn.innerText = "é€å‡ºç•™è¨€";
            loadComments();
          })
          .withFailureHandler((err) => {
            btn.disabled = false;
            btn.innerText = "é€å‡ºç•™è¨€";
            handleError(err);
          })
          .addComment(payload);
      }

      function handleError(error) {
        console.error('API éŒ¯èª¤:', error);
        document.getElementById('comment-list').innerHTML = 
          '<div class="alert alert-danger">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–è©¦ç®—è¡¨æ¬Šé™ã€‚</div>';
      }

      function navBack() {
        google.script.run.withSuccessHandler(url => {
          window.top.location.href = url + '?page=About';
        }).getScriptUrl();
      }
    </script>
  </body>
</html>